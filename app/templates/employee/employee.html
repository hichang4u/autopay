{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>직원관리</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#employeeModal">
            <i class="bi bi-plus-lg me-1"></i>직원 등록
        </button>
    </div>

    <!-- 직원 등록/수정 모달 -->
    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">직원 정보 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column" style="height: calc(100vh - 120px);">
                    <!-- 기본 정보 -->
                    <div class="p-3 bg-light border-bottom">
                        <form id="employeeForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">사번 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="empNumber" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">성명 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">생년월일</label>
                                    <input type="date" class="form-control" id="birthDate">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">입사일</label>
                                    <input type="date" class="form-control" id="joinDate">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">직위</label>
                                    <select class="form-select" id="position">
                                        <option value="">선택</option>
                                        <option value="사원">사원</option>
                                        <option value="대리">대리</option>
                                        <option value="과장">과장</option>
                                        <option value="차장">차장</option>
                                        <option value="부장">부장</option>
                                        <option value="이사">이사</option>
                                        <option value="상무">상무</option>
                                        <option value="전무">전무</option>
                                        <option value="사장">사장</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="email">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 테이블 툴바 -->
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small" id="selectedCount">총 0명 | 선택 0명</span>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEmployeeRow()">
                                    <i class="bi bi-plus-lg me-1"></i>직원 추가
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteSelectedRows()">
                                    <i class="bi bi-trash me-1"></i>선택 삭제
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnExcelDownload">
                                    <i class="bi bi-file-earmark-excel me-1"></i>엑셀
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 테이블 영역 -->
                    <div class="table-container flex-grow-1">
                        <div class="table-responsive h-100">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="checkAll" onchange="toggleAllCheckboxes(this)">
                                            </div>
                                        </th>
                                        <th>사번</th>
                                        <th>성명</th>
                                        <th>생년월일</th>
                                        <th>입사일</th>
                                        <th>직위</th>
                                        <th>이메일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeTableBody">
                                    <!-- 여기에 행이 동적으로 추가됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveEmployeeData()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 직원 현황 카드 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">전체 직원</h6>
                            <h3 class="mb-0" id="totalEmployeeCount">0명</h3>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-people fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">이번 달 입사</h6>
                            <h3 class="mb-0" id="newEmployeeCount">0명</h3>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-person-plus fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 직원 목록 -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <!-- 검색 영역 -->
            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" id="searchQuery" placeholder="검색어">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="searchPosition">
                        <option value="">직위 선택</option>
                        <option value="사원">사원</option>
                        <option value="대리">대리</option>
                        <option value="과장">과장</option>
                        <option value="차장">차장</option>
                        <option value="부장">부장</option>
                        <option value="이사">이사</option>
                        <option value="상무">상무</option>
                        <option value="전무">전무</option>
                        <option value="사장">사장</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <input type="date" class="form-control" id="startDate">
                        <span class="input-group-text">~</span>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary btn-sm w-100" id="btnSearch">
                        <i class="bi bi-search me-1"></i>검색
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover employee-list">
                    <thead>
                        <tr>
                            <th>사번</th>
                            <th>성명</th>
                            <th>생년월일</th>
                            <th>입사일</th>
                            <th>직위</th>
                            <th>이메일</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 여기에 데이터가 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Toast 메시지 -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<style>
/* 모달 관련 스타일 */
.modal-fullscreen {
    padding: 0;
}

.modal-fullscreen .modal-content {
    border: 0;
    border-radius: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* 테이블 관련 스타일 */
#employeeModal .table-container {
    overflow: hidden;
    position: relative;
}

#employeeModal .table-responsive {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: auto;
}

#employeeModal .table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 1;
}

/* 스크롤바 스타일 */
#employeeModal .table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#employeeModal .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#employeeModal .table-responsive::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}

#employeeModal .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* 카드 스타일 */
.card {
    box-shadow: 0 0 0.875rem 0 rgba(33,37,41,.05);
    margin-bottom: 24px;
    border: 0;
}

.card-body {
    padding: 1.25rem;
}

/* 폼 스타일 */
.form-label {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.form-control-sm, .form-select-sm {
    font-size: 0.875rem;
}

.input-group-sm > .form-control,
.input-group-sm > .input-group-text {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

/* 토스트 메시지 */
.toast-container {
    z-index: 9999;
}

.toast {
    font-size: 0.875rem;
}
</style>

<script>
// CSRF 토큰 가져오기
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// 전체 선택 기능
function toggleAllCheckboxes(source) {
    const checkboxes = document.querySelectorAll('#employeeModal tbody .form-check-input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
    updateSelectedCount();
}

// 선택된 항목 수 업데이트
function updateSelectedCount() {
    const totalRows = document.querySelectorAll('#employeeModal tbody tr').length;
    const selectedRows = document.querySelectorAll('#employeeModal tbody .form-check-input:checked').length;
    document.querySelector('#selectedCount').textContent = `총 ${totalRows}명 | 선택 ${selectedRows}명`;
}

// 직원 행 추가
function addEmployeeRow() {
    const tbody = document.querySelector('#employeeTableBody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
        <td>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" onchange="updateSelectedCount()">
            </div>
        </td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><input type="date" class="form-control form-control-sm"></td>
        <td><input type="date" class="form-control form-control-sm"></td>
        <td>
            <select class="form-select form-select-sm">
                <option value="">선택</option>
                <option value="사원">사원</option>
                <option value="대리">대리</option>
                <option value="과장">과장</option>
                <option value="차장">차장</option>
                <option value="부장">부장</option>
                <option value="이사">이사</option>
                <option value="상무">상무</option>
                <option value="전무">전무</option>
                <option value="사장">사장</option>
            </select>
        </td>
        <td><input type="email" class="form-control form-control-sm"></td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); updateSelectedCount();">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    updateSelectedCount();
}

// 선택된 행 삭제
function deleteSelectedRows() {
    const selectedRows = document.querySelectorAll('#employeeModal tbody .form-check-input:checked');
    if (selectedRows.length === 0) {
        showToast('error', '삭제할 항목을 선택해주세요.');
        return;
    }
    
    if (confirm(`선택한 ${selectedRows.length}명의 직원을 삭제하시겠습니까?`)) {
        selectedRows.forEach(checkbox => {
            checkbox.closest('tr').remove();
        });
        document.querySelector('#checkAll').checked = false;
        updateSelectedCount();
    }
}

// 직원 데이터 저장
async function saveEmployeeData() {
    const rows = document.querySelectorAll('#employeeTableBody tr');
    const employees = [];
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const employee = {
            emp_number: inputs[1].value.trim(),
            name: inputs[2].value.trim(),
            birth_date: inputs[3].value || null,
            join_date: inputs[4].value || null,
            position: inputs[5].value || '',
            email: inputs[6].value.trim() || ''
        };
        
        if (employee.emp_number && employee.name) {
            employees.push(employee);
        }
    });
    
    if (employees.length === 0) {
        showToast('error', '저장할 데이터가 없습니다.');
        return;
    }
    
    try {
        const response = await fetch('/employee/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(employees[0])  // 단일 직원 데이터만 전송
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', '저장되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
            loadEmployeeList();
        } else {
            showToast('error', result.message || '저장 중 오류가 발생했습니다.');
            if (result.errors) {
                console.error('Validation errors:', result.errors);
            }
        }
    } catch (error) {
        showToast('error', '저장 중 오류가 발생했습니다.');
        console.error('Save error:', error);
    }
}

// 직원 목록 조회
async function loadEmployeeList() {
    try {
        const response = await fetch('/employee/list');
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('.employee-list tbody');
            tbody.innerHTML = '';
            
            result.data.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.emp_number}</td>
                    <td>${employee.name}</td>
                    <td>${employee.birth_date || '-'}</td>
                    <td>${employee.join_date || '-'}</td>
                    <td>${employee.position || '-'}</td>
                    <td>${employee.email || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editEmployee(${employee.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteEmployee(${employee.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 직원 수 업데이트
            document.getElementById('totalEmployeeCount').textContent = `${result.data.length}명`;
            
            // 이번 달 입사자 수 계산
            const thisMonth = new Date().toISOString().slice(0, 7);
            const newEmployees = result.data.filter(emp => emp.join_date?.startsWith(thisMonth));
            document.getElementById('newEmployeeCount').textContent = `${newEmployees.length}명`;
        }
    } catch (error) {
        showToast('error', '데이터 조회 중 오류가 발생했습니다.');
    }
}

// 직원 수정
async function editEmployee(id) {
    try {
        const response = await fetch(`/employee/${id}`);
        const result = await response.json();
        
        if (result.success) {
            const employee = result.data;
            
            // 모달 필드에 데이터 설정
            document.getElementById('empNumber').value = employee.emp_number;
            document.getElementById('name').value = employee.name;
            document.getElementById('birthDate').value = employee.birth_date || '';
            document.getElementById('joinDate').value = employee.join_date || '';
            document.getElementById('position').value = employee.position || '';
            document.getElementById('email').value = employee.email || '';
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
            modal.show();
        }
    } catch (error) {
        showToast('error', '데이터 조회 중 오류가 발생했습니다.');
    }
}

// 직원 삭제
async function deleteEmployee(id) {
    if (!confirm('선택한 직원을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/employee/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const result = await response.json();
        
        if (result.success) {
            showToast('success', '삭제되었습니다.');
            loadEmployeeList();
        } else {
            showToast('error', result.message);
        }
    } catch (error) {
        showToast('error', '삭제 중 오류가 발생했습니다.');
    }
}

// 토스트 메시지 표시
function showToast(type, message) {
    const toastEl = document.getElementById('toast');
    const toastBody = toastEl.querySelector('.toast-body');
    toastBody.textContent = message;
    
    toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
    
    switch (type) {
        case 'success':
            toastEl.classList.add('bg-success', 'text-white');
            break;
        case 'error':
            toastEl.classList.add('bg-danger', 'text-white');
            break;
    }
    
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

// 검색 기능
document.getElementById('btnSearch').addEventListener('click', async function() {
    const params = new URLSearchParams({
        query: document.getElementById('searchQuery').value,
        position: document.getElementById('searchPosition').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value
    });
    
    try {
        const response = await fetch(`/employee/search?${params}`, {
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('.employee-list tbody');
            tbody.innerHTML = '';
            
            result.data.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.emp_number}</td>
                    <td>${employee.name}</td>
                    <td>${employee.birth_date || '-'}</td>
                    <td>${employee.join_date || '-'}</td>
                    <td>${employee.position || '-'}</td>
                    <td>${employee.email || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editEmployee(${employee.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteEmployee(${employee.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        showToast('error', '검색 중 오류가 발생했습니다.');
    }
});

// 엑셀 다운로드
document.getElementById('btnExcelDownload').addEventListener('click', async function() {
    try {
        const response = await fetch('/employee/export', {
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `직원명부_${new Date().toISOString().slice(0, 10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        showToast('error', '엑셀 다운로드 중 오류가 발생했습니다.');
    }
});

// 페이지 로드 시 데이터 조회
document.addEventListener('DOMContentLoaded', () => {
    loadEmployeeList();
});
</script>
{% endblock %} 