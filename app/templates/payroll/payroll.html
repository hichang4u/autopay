{% extends "base.html" %}

{% block content %}
<!-- CSRF 토큰 추가 -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<!-- Toast 메시지 -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>급여관리</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generatePayrollModal">
            <i class="bi bi-plus-lg me-1"></i>급여명세서 생성
        </button>
    </div>

    <!-- 급여명세서 생성 모달 -->
    <div class="modal fade" id="generatePayrollModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">급여정산 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column" style="height: calc(100vh - 120px);">
                    <!-- 기본 정보 -->
                    <div class="p-3 bg-light border-bottom">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">귀속연월</label>
                                <input type="month" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">지급일</label>
                                <input type="date" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- 테이블 툴바 -->
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small" id="selectedCount">총 0명 | 선택 0명</span>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAllEmployees()">
                                    <i class="bi bi-plus-lg me-1"></i>직원 추가
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteSelectedRows()">
                                    <i class="bi bi-trash me-1"></i>선택 삭제
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="autoCalculate()">
                                    <i class="bi bi-calculator me-1"></i>자동계산
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 테이블 영역 -->
                    <div class="table-container flex-grow-1">
                        <div class="table-responsive h-100">
                            <table class="table table-hover mb-0" style="min-width: 2000px;">
                                <thead>
                                    <tr>
                                        <th rowspan="2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="checkAll" onchange="toggleAllCheckboxes(this)">
                                            </div>
                                        </th>
                                        <th colspan="4" class="text-center">기본정보</th>
                                        <th colspan="5" class="text-center">지급항목</th>
                                        <th colspan="7" class="text-center">공제항목</th>
                                        <th rowspan="2" class="text-center">실수령액</th>
                                    </tr>
                                    <tr>
                                        <th>사번</th>
                                        <th>성명</th>
                                        <th>부서</th>
                                        <th>직위</th>
                                        
                                        <!-- 지급 항목 -->
                                        <th>기본급</th>
                                        <th>직책수당</th>
                                        <th>식대</th>
                                        <th>자가운전보조금</th>
                                        <th>지급액 계</th>
                                        
                                        <!-- 공제 항목 -->
                                        <th>소득세</th>
                                        <th>지방소득세</th>
                                        <th>국민연금</th>
                                        <th>건강보험</th>
                                        <th>장기요양보험</th>
                                        <th>고용보험</th>
                                        <th>공제액 계</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 여기에 데이터가 동적으로 추가됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="btnSave" onclick="savePayrollData()">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">저장</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 급여 처리 현황 카드 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">이번 달 처리 현황</h6>
                            <h3 class="mb-0">32/45</h3>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-file-earmark-text fs-1"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" role="progressbar" style="width: 71%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">이메일 발송</h6>
                            <h3 class="mb-0">28/45</h3>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-envelope-check fs-1"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 62%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 급여 처리 목록 -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover payroll-list">
                    <thead>
                        <tr>
                            <th>지급일</th>
                            <th>구분</th>
                            <th>인원수</th>
                            <th>처리상태</th>
                            <th>생성일시</th>
                            <th>수정일시</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 여기에 데이터가 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
/* 모달 관련 스타일 */
.modal-fullscreen {
    padding: 0;
}

.modal-fullscreen .modal-content {
    border: 0;
    border-radius: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* 테이블 관련 스타일 */
#generatePayrollModal .table-container {
    overflow: hidden;
    position: relative;
}

#generatePayrollModal .table-responsive {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: auto;
}

#generatePayrollModal .table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 1;
}

/* 스크롤바 스타일 */
#generatePayrollModal .table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#generatePayrollModal .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#generatePayrollModal .table-responsive::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}

#generatePayrollModal .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #999;
}
</style>

<script>
// 전체 선택 기능
function toggleAllCheckboxes(source) {
    const checkboxes = document.querySelectorAll('#generatePayrollModal tbody .form-check-input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
    updateSelectedCount();
}

// 선택된 항목 수 업데이트
function updateSelectedCount() {
    const totalRows = document.querySelectorAll('#generatePayrollModal tbody tr').length;
    const selectedRows = document.querySelectorAll('#generatePayrollModal tbody .form-check-input:checked').length;
    document.querySelector('#selectedCount').textContent = `총 ${totalRows}명 | 선택 ${selectedRows}명`;
}

// 선택된 행 삭제
function deleteSelectedRows() {
    const selectedRows = document.querySelectorAll('#generatePayrollModal tbody .form-check-input:checked');
    selectedRows.forEach(checkbox => {
        checkbox.closest('tr').remove();
    });
    document.querySelector('#checkAll').checked = false;
    updateSelectedCount();
}

// 숫자 포맷 함수 수정
function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// 쉼표 제거 함수 추가
function unformatNumber(str) {
    return parseInt(str.replace(/,/g, '')) || 0;
}

// 자동계산 함수 수정 (공제 항목만)
function autoCalculate() {
    const modal = document.getElementById('generatePayrollModal');
    const rows = modal.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        // 지급액 계 가져오기
        const totalPaymentInput = row.querySelector('td:nth-child(10) input');
        const totalPayment = unformatNumber(totalPaymentInput.value);
        
        // 국민연금 (4.5%)
        const nationalPension = Math.round(totalPayment * 0.045 / 10) * 10;
        row.querySelector('td:nth-child(13) input').value = formatNumber(nationalPension);
        
        // 건강보험 (3.545%)
        const healthInsurance = Math.round(totalPayment * 0.03545 / 10) * 10;
        row.querySelector('td:nth-child(14) input').value = formatNumber(healthInsurance);
        
        // 장기요양보험 (건강보험료의 12.95%)
        const longTermCare = Math.round(healthInsurance * 0.1295 / 10) * 10;
        row.querySelector('td:nth-child(15) input').value = formatNumber(longTermCare);
        
        // 고용보험 (0.9%)
        const employmentInsurance = Math.round(totalPayment * 0.009 / 10) * 10;
        row.querySelector('td:nth-child(16) input').value = formatNumber(employmentInsurance);
        
        // 소득세 (6.78%)
        const incomeTax = Math.round(totalPayment * 0.0678 / 10) * 10;
        row.querySelector('td:nth-child(11) input').value = formatNumber(incomeTax);
        
        // 지방소득세 (소득세의 10%)
        const localIncomeTax = Math.round(incomeTax * 0.1 / 10) * 10;
        row.querySelector('td:nth-child(12) input').value = formatNumber(localIncomeTax);
        
        // 공제액 계
        const totalDeduction = nationalPension + healthInsurance + longTermCare + 
                             employmentInsurance + incomeTax + localIncomeTax;
        row.querySelector('td:nth-child(17) input').value = formatNumber(totalDeduction);
        
        // 실수령액 계산
        const netAmount = totalPayment - totalDeduction;
        row.querySelector('td:nth-child(18) input').value = formatNumber(netAmount);
    });
}

// 행 추가 함수 정의
function addEmployeeRow() {
    const table = document.querySelector('#generatePayrollModal table tbody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
        <td>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" onchange="updateSelectedCount()">
            </div>
        </td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><input type="text" class="form-control form-control-sm"></td>
        
        <!-- 지급 항목 -->
        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
        
        <!-- 공제 항목 -->
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
        <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
        
        <!-- 실수령액 -->
        <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
    `;
    
    table.appendChild(newRow);
    updateSelectedCount();
    setupCalculations(newRow);
}

// CSRF 토큰 가져오기 함수 추가
function getCSRFToken() {
    return document.querySelector('input[name="csrf_token"]').value;
}

// Toast 메시지 표시 함수
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastBody = toast.querySelector('.toast-body');
    
    // 메시지 설정
    toastBody.textContent = message;
    
    // 스타일 설정
    toast.className = 'toast align-items-center border-0';
    switch (type) {
        case 'success':
            toast.classList.add('bg-success', 'text-white');
            break;
        case 'error':
            toast.classList.add('bg-danger', 'text-white');
            break;
        case 'warning':
            toast.classList.add('bg-warning', 'text-white');
            break;
    }
    
    // Toast 표시
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// 급여 데이터 저장
async function savePayrollData() {
    // 기본 정보 가져오기
    const payYearMonth = document.querySelector('#generatePayrollModal input[type="month"]').value;
    const paymentDate = document.querySelector('#generatePayrollModal input[type="date"]').value;
    
    if (!payYearMonth || !paymentDate) {
        await showWarning('귀속연월과 지급일을 입력해주세요.');
        return;
    }
    
    // 직원 데이터 수집
    const employees = [];
    const rows = document.querySelectorAll('#generatePayrollModal tbody tr');
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const employee = {
            employee_id: inputs[1].value,
            employee_name: inputs[2].value,
            department: inputs[3].value,
            position: inputs[4].value,
            
            // 지급 항목
            base_salary: unformatNumber(inputs[5].value),
            position_allowance: unformatNumber(inputs[6].value),
            meal_allowance: unformatNumber(inputs[7].value),
            car_allowance: unformatNumber(inputs[8].value),
            
            // 공제 항목
            income_tax: unformatNumber(inputs[10].value),
            local_income_tax: unformatNumber(inputs[11].value),
            national_pension: unformatNumber(inputs[12].value),
            health_insurance: unformatNumber(inputs[13].value),
            long_term_care: unformatNumber(inputs[14].value),
            employment_insurance: unformatNumber(inputs[15].value)
        };
        
        if (employee.employee_id && employee.employee_name) {
            employees.push(employee);
        }
    });
    
    if (employees.length === 0) {
        await showWarning('저장할 데이터가 없습니다.');
        return;
    }

    // 저장 확인
    const confirmResult = await showConfirm('현재 력된 급여 데이터를 저장하시겠습니까?', '저장');
    if (!confirmResult.isConfirmed) {
        return;
    }

    // 저장 버튼 상태 변경
    const saveButton = document.querySelector('#btnSave');
    const spinner = saveButton.querySelector('.spinner-border');
    const btnText = saveButton.querySelector('.btn-text');
    
    saveButton.disabled = true;
    spinner.classList.remove('d-none');
    btnText.textContent = '저장 중...';
    
    try {
        showLoading('저장 중...');

        const response = await fetch('/payroll/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                pay_year_month: payYearMonth,
                payment_date: paymentDate,
                employees: employees
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showSuccess(result.message || '급여 데이터가 성공적으로 저장되었습니다.');
            location.reload();
        } else {
            let errorMessage = result.message;
            if (result.errors) {
                errorMessage += '\n' + result.errors.join('\n');
            }
            await showError(errorMessage);
        }
    } catch (error) {
        await showError('저장 중 오류가 발생했습니다: ' + error.message);
    } finally {
        // 저장 버튼 상태 복원
        saveButton.disabled = false;
        spinner.classList.add('d-none');
        btnText.textContent = '저장';
        Swal.close();
    }
}

// 급여 데이터 수정
async function updatePayrollData(recordId) {
    // 수정 확인
    const confirmResult = await showConfirm('변경사항을 저장하시겠습니까?', '수정');
    if (!confirmResult.isConfirmed) {
        return;
    }

    try {
        const modal = document.querySelector('#generatePayrollModal');
        const payYearMonth = modal.querySelector('input[type="month"]').value;
        const paymentDate = modal.querySelector('input[type="date"]').value;
        
        // 직원 데이터 수집
        const employees = [];
        const rows = modal.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const employee = {
                employee_id: inputs[1].value,
                employee_name: inputs[2].value,
                department: inputs[3].value,
                position: inputs[4].value,
                
                // 지급 항목
                base_salary: unformatNumber(inputs[5].value),
                position_allowance: unformatNumber(inputs[6].value),
                meal_allowance: unformatNumber(inputs[7].value),
                car_allowance: unformatNumber(inputs[8].value),
                
                // 공제 항목
                income_tax: unformatNumber(inputs[10].value),
                local_income_tax: unformatNumber(inputs[11].value),
                national_pension: unformatNumber(inputs[12].value),
                health_insurance: unformatNumber(inputs[13].value),
                long_term_care: unformatNumber(inputs[14].value),
                employment_insurance: unformatNumber(inputs[15].value)
            };
            employees.push(employee);
        });

        // 수정 버튼 상태 변경
        const updateButton = modal.querySelector('.modal-footer .btn-primary');
        const spinner = updateButton.querySelector('.spinner-border');
        const btnText = updateButton.querySelector('.btn-text');
        
        updateButton.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = '수정 중...';
        
        showLoading('수정 중...');

        const response = await fetch(`/payroll/update/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                pay_year_month: payYearMonth,
                payment_date: paymentDate,
                employees: employees
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showSuccess(result.message || '급여 데이터가 성공적으로 수정되었습니다.');
            location.reload();
        } else {
            await showError(result.message);
        }
    } catch (error) {
        await showError('수정 중 오류가 발생했습니다: ' + error.message);
    } finally {
        // 수정 버튼 상태 복원
        const modal = document.querySelector('#generatePayrollModal');
        const updateButton = modal.querySelector('.modal-footer .btn-primary');
        const spinner = updateButton.querySelector('.spinner-border');
        const btnText = updateButton.querySelector('.btn-text');
        
        updateButton.disabled = false;
        spinner.classList.add('d-none');
        btnText.textContent = '수정';
        Swal.close();
    }
}

// 급여 처리 완료
async function completePayroll(recordId) {
    const confirmResult = await showConfirm('급여 처리를 완료하시겠습니까?\n완료 후에는 수정할 수 없습니다.', '완료');
    if (!confirmResult.isConfirmed) {
        return;
    }

    try {
        showLoading('처리 중...');

        const response = await fetch(`/payroll/status/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                status: '완료'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showSuccess(result.message || '급여 처리가 완료되었습니다.');
            location.reload();
        } else {
            await showError(result.message);
        }
    } catch (error) {
        await showError('처리 중 오류가 발생했습니다: ' + error.message);
    } finally {
        Swal.close();
    }
}

// 이메일 발송 함수
async function sendPayrollEmail(recordId) {
    try {
        showLoading('이메일 발송 중...');

        const response = await fetch(`/payroll/send_email/${recordId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showSuccess('이메일이 성공적으로 발송되었습니다.');
            location.reload();
        } else {
            await showError(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        await showError('이메일 발송 중 오류가 발생했습니다.');
    } finally {
        Swal.close();
    }
}

// 페이지 로드 시 데이터 조회
document.addEventListener('DOMContentLoaded', () => {
    loadPayrollList();
});

// 모든 직원 추가 함수
async function addAllEmployees() {
    try {
        const response = await fetch('/employee/list');
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('#generatePayrollModal tbody');
            
            result.data.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" onchange="updateSelectedCount()">
                        </div>
                    </td>
                    <td><input type="text" class="form-control form-control-sm" value="${employee.emp_number}" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" value="${employee.name}" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" value="${employee.department || ''}" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" value="${employee.position || ''}" readonly></td>
                    
                    <!-- 지급 항목 -->
                    <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end payment-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
                    
                    <!-- 공제 항목 -->
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="0"></td>
                    <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
                    
                    <!-- 실수령액 -->
                    <td><input type="text" class="form-control form-control-sm text-end" value="0" readonly></td>
                `;
                
                tbody.appendChild(row);
                setupCalculations(row);
            });
            
            updateSelectedCount();
        } else {
            alert('직원 목록을 불러오는데 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('직원 목록을 불러오는 중 오류가 발생했습니다.');
    }
}

// 급여 행 추가
function addPayrollRow(employee) {
    const tbody = document.getElementById('payrollTableBody');
    const newRow = document.createElement('tr');
    
    // 기본급 계산 (직위별 기본급 설정 필요)
    const baseSalary = calculateBaseSalary(employee.position);
    
    newRow.innerHTML = `
        <td>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" onchange="updateSelectedCount()">
            </div>
        </td>
        <td>${employee.emp_number}</td>
        <td>${employee.name}</td>
        <td>${employee.department || '-'}</td>
        <td>${employee.position || '-'}</td>
        <td><input type="number" class="form-control form-control-sm text-end base-salary" value="${baseSalary}" onchange="calculateTotal(this.closest('tr'))"></td>
        <td><input type="number" class="form-control form-control-sm text-end overtime-pay" value="0" onchange="calculateTotal(this.closest('tr'))"></td>
        <td><input type="number" class="form-control form-control-sm text-end bonus" value="0" onchange="calculateTotal(this.closest('tr'))"></td>
        <td><input type="number" class="form-control form-control-sm text-end meal-allowance" value="0" onchange="calculateTotal(this.closest('tr'))"></td>
        <td class="text-end total-amount">0</td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); updateSelectedCount();">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    calculateTotal(newRow);
    updateSelectedCount();
}

// 통합된 상태 뱃지 생성 함수
function getStatusBadge(record) {
    const statusMap = {
        'TEMP_SAVE': {
            class: 'bg-warning text-dark',
            text: '임시저장'
        },
        'PROC_CMPT': {
            class: 'bg-success text-white',
            text: '완료'
        },
        'PDF_GEN': {
            class: 'bg-info text-white',
            text: 'PDF생성',
            timestamp: record.pdf_generated_at
        },
        'MAIL_SENT': {
            class: 'bg-primary text-white',
            text: '발송완료',
            timestamp: record.email_sent_at
        }
    };

    // 상태값이 깨진 우를 처리하기 위한 정규화 함수
    function normalizeStatus(status) {
        if (status.includes('임시') || status.includes('저장')) return 'TEMP_SAVE';
        if (status === '완료') return 'PROC_CMPT';
        if (status.includes('PDF')) return 'PDF_GEN';
        if (status.includes('발송')) return 'MAIL_SENT';
        return status;
    }

    const status = normalizeStatus(record.status);
    const config = statusMap[status] || {
        class: 'bg-secondary text-white',
        text: status  // 매핑되지 않은 상태는 그대로 표시
    };

    const badge = document.createElement('span');
    badge.className = `badge ${config.class}`;
    badge.style.fontSize = '0.875rem';
    badge.style.padding = '0.4rem 0.6rem';
    badge.style.whiteSpace = 'nowrap';
    
    let content = config.text;
    if (config.timestamp) {
        content += `<br><small style="font-size: 0.75rem;">${formatDateTime(config.timestamp)}</small>`;
    }
    
    badge.innerHTML = content;
    return badge.outerHTML;
}

// 날짜 포맷팅 함수 (하나로 통합)
function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    }).format(date);
}

// 상태별 작업 버튼 생성 함수
function getActionButtons(record) {
    // 기본 버튼 스타일 정의
    const btnStyle = {
        view: 'btn-outline-secondary',    // 조회
        delete: 'btn-outline-danger',     // 삭제
        complete: 'btn-outline-primary',  // 완료
        pdf: 'btn-outline-success',       // PDF
        email: 'btn-outline-info'         // 이메일
    };

    // 상태값 정규화 함수
    function normalizeStatus(status) {
        if (status.includes('임시') || status.includes('저장')) return 'TEMP_SAVE';
        if (status === '완료') return 'PROC_CMPT';
        if (status.includes('PDF')) return 'PDF_GEN';
        if (status.includes('발송')) return 'MAIL_SENT';
        return status;
    }

    const status = normalizeStatus(record.status);

    // 상태별 버튼 구성
    const buttons = {
        // 임시저장 상태 - 조회, 삭제, 완료 처리 가능
        'TEMP_SAVE': `
            <button class="btn btn-sm ${btnStyle.view} me-1" onclick="viewPayrollDetail(${record.id})" title="상세보기">
                <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.delete} me-1" onclick="deletePayroll(${record.id})" title="삭제">
                <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.complete}" onclick="completePayroll(${record.id})" title="완료처리">
                <i class="bi bi-check-lg"></i>
            </button>
        `,
        
        // 완료 상태 - 조회와 PDF 생성 가능
        'PROC_CMPT': `
            <button class="btn btn-sm ${btnStyle.view} me-1" onclick="viewPayrollDetail(${record.id})" title="상세보기">
                <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.pdf}" onclick="handlePayrollDocument(${record.id})" title="PDF 생성">
                <i class="bi bi-file-earmark-text"></i>
            </button>
        `,
        
        // PDF생성 상태 - 조회와 이메일 발송 가능
        'PDF_GEN': `
            <button class="btn btn-sm ${btnStyle.view} me-1" onclick="viewPayrollDetail(${record.id})" title="상세보기">
                <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.email}" onclick="sendPayrollEmails(${record.id})" title="이메일 발송">
                <i class="bi bi-envelope"></i>
            </button>
        `,
        
        // 발송완료 상태 - 조회, PDF 조회, 재발송 가능
        'MAIL_SENT': `
            <button class="btn btn-sm ${btnStyle.view} me-1" onclick="viewPayrollDetail(${record.id})" title="상세보기">
                <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.pdf} me-1" onclick="viewPayrollDocuments(${record.id})" title="PDF 조회">
                <i class="bi bi-file-pdf"></i>
            </button>
            <button class="btn btn-sm ${btnStyle.email}" onclick="resendPayrollEmails(${record.id})" title="이메일 재발송">
                <i class="bi bi-envelope-fill"></i>
            </button>
        `
    };

    // 상태가 없거나 매핑되지 않은 경우 조회 버튼만 표시
    const defaultButtons = `
        <button class="btn btn-sm ${btnStyle.view}" onclick="viewPayrollDetail(${record.id})" title="상세보기">
            <i class="bi bi-search"></i>
        </button>
    `;

    // 버튼 그룹으로 구성하여 반환
    return `
        <div class="btn-group" role="group" aria-label="작업 버튼">
            ${buttons[status] || defaultButtons}
        </div>
    `;
}

// 급여 데이터 목록 조회 함수 수정
async function loadPayrollList() {
    try {
        showLoading('데이터 조회 중...');
        
        const response = await fetch('/payroll/list');
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('.payroll-list tbody');
            tbody.innerHTML = '';
            
            result.data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.payment_date}</td>
                    <td>${record.pay_year_month} 급여</td>
                    <td>${record.employee_count}명</td>
                    <td>${getStatusBadge(record)}</td>
                    <td>${formatDateTime(record.created_at)}</td>
                    <td>${formatDateTime(record.updated_at)}</td>
                    <td>${getActionButtons(record)}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            await showError(result.message || '데이터 조회에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        await showError('데이터 조회 중 오류가 발생했습니다.');
    } finally {
        Swal.close();
    }
}

// 급여명세서 처리 함수
async function handlePayrollDocument(recordId) {
    try {
        showLoading('PDF 생성 중...');
        
        const response = await fetch(`/generate-pdf/${recordId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            await showSuccess(result.message);
            // 목록 새로고침
            loadPayrollList();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        await showError('PDF 생성 중 오류가 발생했습니다: ' + error.message);
    } finally {
        Swal.close();
    }
}

// PDF 조회 함수
async function viewPayrollDocuments(recordId) {
    try {
        const response = await fetch(`/payroll/documents/${recordId}`);
        const result = await response.json();
        
        if (result.success) {
            // PDF 목록을 모달로 표시
            showPDFListModal(result.data);
        } else {
            await showError(result.message);
        }
    } catch (error) {
        await showError('PDF 조회 중 오류가 발생했습니다: ' + error.message);
    }
}

// 이메일 재발송 함수
async function resendPayrollEmails(recordId) {
    const confirmResult = await showConfirm(
        '급여명세서를 다시 송하시겠습니까?',
        '이메일 재발송'
    );
    
    if (confirmResult.isConfirmed) {
        try {
            showLoading('이메일 발송 중...');
            
            const response = await fetch(`/payroll/send-emails/${recordId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                await showSuccess(result.message);
                loadPayrollList();  // 목록 새로고침
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            await showError('이메일 발송 중 오류가 발생했습니다: ' + error.message);
        } finally {
            Swal.close();
        }
    }
}

// 페이지 로드 시 데이터 조회
document.addEventListener('DOMContentLoaded', () => {
    loadPayrollList();
});

// 급여 상세 조회 함수
async function viewPayrollDetail(recordId) {
    try {
        showLoading('데이터 조회 중...');
        
        const response = await fetch(`/payroll/detail/${recordId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            // 모달 초기화
            const modal = new bootstrap.Modal(document.getElementById('generatePayrollModal'));
            const modalTitle = document.querySelector('#generatePayrollModal .modal-title');
            
            // 임시저장 상태 확인
            const isEditable = result.data.status === 'TEMP_SAVE' || result.data.status === '임시저장';
            modalTitle.textContent = isEditable ? '급여정산 수정' : '급여정산 상세보기';
            
            // 기본 정보 설정
            const payYearMonthInput = document.querySelector('#generatePayrollModal input[type="month"]');
            const paymentDateInput = document.querySelector('#generatePayrollModal input[type="date"]').value;
            
            payYearMonthInput.value = result.data.pay_year_month || '';
            paymentDateInput.value = result.data.payment_date || '';
            
            // 읽기 전용 설정
            payYearMonthInput.readOnly = !isEditable;
            paymentDateInput.readOnly = !isEditable;
            
            // 테이블 초기화
            const tbody = document.querySelector('#generatePayrollModal tbody');
            tbody.innerHTML = '';
            
            // 직원 데이터 표시
            if (result.data.details && Array.isArray(result.data.details)) {
                result.data.details.forEach(detail => {
                    // 지급액 계 계산
                    const totalPayment = (detail.base_salary || 0) + 
                                      (detail.position_allowance || 0) + 
                                      (detail.meal_allowance || 0) + 
                                      (detail.car_allowance || 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" ${isEditable ? '' : 'disabled'}>
                            </div>
                        </td>
                        <td><input type="text" class="form-control form-control-sm" value="${detail.employee_id || ''}" readonly></td>
                        <td><input type="text" class="form-control form-control-sm" value="${detail.employee_name || ''}" readonly></td>
                        <td><input type="text" class="form-control form-control-sm" value="${detail.department || ''}" readonly></td>
                        <td><input type="text" class="form-control form-control-sm" value="${detail.position || ''}" readonly></td>
                        
                        <!-- 지급 항목 -->
                        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="${formatNumber(detail.base_salary || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="${formatNumber(detail.position_allowance || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="${formatNumber(detail.meal_allowance || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end payment-item" value="${formatNumber(detail.car_allowance || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end" value="${formatNumber(totalPayment)}" readonly></td>
                        
                        <!-- 공제 항목 -->
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.income_tax || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.local_income_tax || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.national_pension || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.health_insurance || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.long_term_care || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end deduction-item" value="${formatNumber(detail.employment_insurance || 0)}" ${isEditable ? '' : 'readonly'}></td>
                        <td><input type="text" class="form-control form-control-sm text-end" value="${formatNumber(detail.total_deduction || 0)}" readonly></td>
                        
                        <!-- 실수령액 -->
                        <td><input type="text" class="form-control form-control-sm text-end" value="${formatNumber((totalPayment || 0) - (detail.total_deduction || 0))}" readonly></td>
                    `;
                    tbody.appendChild(row);
                    if (isEditable) {
                        setupCalculations(row);
                    }
                });
            }
            
            // 버튼 영역 수정
            const modalFooter = document.querySelector('#generatePayrollModal .modal-footer');
            if (isEditable) {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updatePayrollData(${recordId})">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">수정</span>
                    </button>
                `;
            } else {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                `;
            }
            
            // 모달 표시
            modal.show();
        } else {
            throw new Error(result.message || '데이터가 없거나 조회에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        await showError('상세 정보 조회 중 오류가 발생했습니다: ' + error.message);
    } finally {
        Swal.close();
    }
}

// 급여 데이터 삭제 함수
async function deletePayroll(recordId) {
    const result = await Swal.fire({
        title: '정말 삭��하시겠습니까?',
        text: "삭제된 데이터는 복구할 수 없습니다.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '삭제',
        cancelButtonText: '취소'
    });
    
    if (result.isConfirmed) {
        try {
            showLoading('삭제 중...');
            
            const response = await fetch(`/payroll/delete/${recordId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                await showSuccess(data.message);
                loadPayrollList();  // 목록 새로고침
            } else {
                await showError(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            await showError('삭제 처리 중 오류가 발생했습니다.');
        } finally {
            Swal.close();
        }
    }
}

// 자동 계산 설정
function setupCalculations(row) {
    const paymentInputs = row.querySelectorAll('.payment-item');
    const deductionInputs = row.querySelectorAll('.deduction-item');
    const totalPaymentInput = row.querySelector('td:nth-child(10) input');
    const totalDeductionInput = row.querySelector('td:nth-child(17) input');
    const netPayInput = row.querySelector('td:nth-child(18) input');
    
    // 입력 필드 포맷팅 설정
    function setupInputFormat(input) {
        input.addEventListener('focus', function() {
            this.value = unformatNumber(this.value);
        });
        
        input.addEventListener('blur', function() {
            this.value = formatNumber(unformatNumber(this.value));
        });
    }
    
    // 모든 금액 입력 필드에 포맷팅 설정
    paymentInputs.forEach(setupInputFormat);
    deductionInputs.forEach(setupInputFormat);
    
    // 지급액 계산
    function calculateTotalPayment() {
        let total = 0;
        paymentInputs.forEach(input => {
            total += unformatNumber(input.value);
        });
        totalPaymentInput.value = formatNumber(total);
        calculateNetPay();
    }
    
    // 공제액 계산
    function calculateTotalDeduction() {
        let total = 0;
        deductionInputs.forEach(input => {
            total += unformatNumber(input.value);
        });
        totalDeductionInput.value = formatNumber(total);
        calculateNetPay();
    }
    
    // 실수령액 계산
    function calculateNetPay() {
        const totalPayment = unformatNumber(totalPaymentInput.value);
        const totalDeduction = unformatNumber(totalDeductionInput.value);
        netPayInput.value = formatNumber(totalPayment - totalDeduction);
    }
    
    // 이벤트 스너 설정
    paymentInputs.forEach(input => {
        input.addEventListener('input', calculateTotalPayment);
    });
    
    deductionInputs.forEach(input => {
        input.addEventListener('input', calculateTotalDeduction);
    });
}

function generatePDF(recordId) {
    if (!confirm('PDF를 생성하시겠습니까?')) {
        return;
    }

    fetch(`/generate-pdf/${recordId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // PDF 생성 성공 후 목록 새로고침
            loadPayrollList();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('PDF 생성 중 오류가 발생했습니다.');
    });
}
</script>
{% endblock %} 